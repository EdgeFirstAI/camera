# GitHub Actions workflow for testing and code quality
#
# This workflow runs tests, performs static analysis, and collects coverage data
# for the EdgeFirst Camera project.
#
# Action Versions (hash-pinned per SPS guidelines):
# - actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 (v4.2.2)
# - actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 (v4.2.3)
# - actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 (v4.6.2)
# - actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e (v4.2.1)
# - dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 (stable)
# - Swatinem/rust-cache@401aff9a7a08acb9d27b64936a90db81024cff97 (v2.8.2)
# - taiki-e/install-action@0e76c5c569f13f7eb21e8e5b26fe710062b57b62 (v2.65.13)
# - codecov/codecov-action@4650159d642e33fdc30954ca22638caf0df6cac8 (v5.4.3)
#
# Runner Notes:
# - ubuntu-22.04: Standard GitHub-hosted runner (x86_64)
# - ubuntu-22.04-arm: GitHub-hosted ARM64 runner for native aarch64 builds/tests
# - nxp-imx8mp-latest: NXP i.MX 8M Plus EVK - hardware test runner (no toolchain)
#
# Build Strategy:
# - x86_64 and aarch64 builds happen on GitHub-hosted runners
# - imx8mp runner downloads aarch64 artifacts and runs hardware tests only
# - This allows testing with real camera, G2D, and VPU hardware

name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_call:  # Allow other workflows to call this

env:
  CARGO_TERM_COLOR: always

jobs:
  format:
    name: Format Check
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm

      - name: Install Rust
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7  # stable
        with:
          toolchain: stable
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all --check

  clippy:
    name: Lint with Clippy
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm

      - name: Install Rust
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7  # stable
        with:
          toolchain: stable
          components: clippy

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@401aff9a7a08acb9d27b64936a90db81024cff97  # v2.8.2
        with:
          shared-key: clippy
          cache-on-failure: true

      - name: Run Clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  test:
    name: Test and Coverage (${{ matrix.platform.name }})
    runs-on: ${{ matrix.platform.runner }}
    permissions:
      contents: read
      checks: write
      pull-requests: write
    strategy:
      matrix:
        platform:
          - name: x86_64
            runner: ubuntu-22.04
          - name: aarch64
            runner: ubuntu-22.04-arm
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm

      - name: Install Rust
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7  # stable
        with:
          toolchain: stable
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@0e76c5c569f13f7eb21e8e5b26fe710062b57b62  # v2.65.13
        with:
          tool: cargo-llvm-cov

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@401aff9a7a08acb9d27b64936a90db81024cff97  # v2.8.2
        with:
          shared-key: ${{ matrix.platform.name }}-test
          cache-on-failure: true

      - name: Run unit tests
        run: cargo test --lib --workspace

      - name: Run doc tests
        run: cargo test --doc --workspace

      # Note: Integration tests require hardware (DMA buffers, G2D, camera devices)
      # and are skipped in CI. Run on target hardware with: cargo test --test '*'

      - name: Generate coverage
        run: |
          # Only generate coverage for unit tests (--lib) and doc tests (--doc)
          # Integration tests require hardware and are excluded
          cargo llvm-cov --lib --workspace --cobertura --output-path coverage.xml
          cargo llvm-cov --doc --workspace --cobertura --output-path coverage-doc.xml || true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@4650159d642e33fdc30954ca22638caf0df6cac8  # v5.4.3
        with:
          files: coverage.xml
          flags: ${{ matrix.platform.name }}
          fail_ci_if_error: false

      - name: Upload test results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        if: always()
        with:
          name: test-results-${{ matrix.platform.name }}
          path: |
            coverage.xml
          retention-days: 30

      - name: Build release binary for hardware testing (aarch64 only)
        if: matrix.platform.name == 'aarch64'
        run: cargo build --release

      - name: Upload binary for hardware testing (aarch64 only)
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        if: matrix.platform.name == 'aarch64'
        with:
          name: binary-aarch64
          path: target/release/edgefirst-camera
          retention-days: 7

  # ===========================================================================
  # Hardware Testing on NXP i.MX8M Plus (test-only, no build)
  # ===========================================================================
  hardware-test:
    name: Hardware Test (imx8mp)
    needs: test
    runs-on: nxp-imx8mp-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
      - name: Clean workspace (self-hosted runner)
        run: |
          # Self-hosted runners persist state between runs
          rm -rf target/ bin/ 2>/dev/null || true

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Download aarch64 binary
        uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e  # v4.2.1
        with:
          name: binary-aarch64
          path: bin/

      - name: Make downloaded binary executable
        run: |
          chmod +x bin/edgefirst-camera
          echo "Binary ready for testing:"
          ls -la bin/
          file bin/edgefirst-camera

      - name: Debug environment info
        run: |
          echo "=== User and groups ==="
          whoami
          id
          groups
          echo ""
          echo "=== DMA heap devices ==="
          ls -la /dev/dma_heap/ || echo "DMA heap directory not found"
          echo ""
          echo "=== G2D device ==="
          ls -la /dev/galcore 2>/dev/null || echo "G2D device not found"
          echo ""
          echo "=== Video devices ==="
          ls -la /dev/video* 2>/dev/null || echo "No video devices found"
          v4l2-ctl --list-devices 2>/dev/null || echo "v4l2-ctl not available"
          echo ""
          echo "=== Camera device /dev/video3 details ==="
          v4l2-ctl --device=/dev/video3 --all 2>&1 || echo "Could not query /dev/video3"
          echo ""
          echo "=== VPU encoder library ==="
          ldconfig -p | grep libhantro_vc8000e || echo "libhantro_vc8000e.so not found"
          echo ""
          echo "=== VideoStream library ==="
          ldconfig -p | grep libvideostream || echo "libvideostream.so not found"

      - name: Test camera binary help
        run: |
          echo "=== Testing binary help output ==="
          ./bin/edgefirst-camera --help

      - name: Test camera with JPEG output
        run: |
          echo "=== Testing JPEG capture (15 seconds) ==="
          # Camera is a continuous streaming service - run for 15 seconds
          # to ensure proper warmup and collect enough data to verify FPS
          # Exit code 124 from timeout means it ran successfully for the duration
          timeout 15 ./bin/edgefirst-camera --jpeg 2>&1 || {
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 124 ]; then
              echo "âœ“ Camera ran successfully for 15 seconds"
              exit 0
            fi
            echo "Camera test failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          }
          echo "âœ“ JPEG capture test passed"

      - name: Test camera with H.264 output
        run: |
          echo "=== Testing H.264 encoding (15 seconds) ==="
          # Camera is a continuous streaming service - run for 15 seconds
          # to ensure proper warmup and collect enough data to verify FPS
          timeout 15 ./bin/edgefirst-camera --h264 2>&1 || {
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 124 ]; then
              echo "âœ“ Camera ran successfully for 15 seconds"
              exit 0
            fi
            echo "H.264 test failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          }
          echo "âœ“ H.264 encoding test passed"

      - name: Test camera multi-resolution streaming
        run: |
          echo "=== Testing multi-resolution streaming ==="

          # Test resolutions supported by typical cameras
          # Camera is a continuous streaming service - run each for 15 seconds
          # to ensure proper warmup and collect enough data to verify FPS
          RESOLUTIONS="640x480 1280x720 1920x1080"
          TESTS_PASSED=0
          TESTS_FAILED=0

          for RES in $RESOLUTIONS; do
            echo ""
            echo "--- Testing resolution: $RES ---"
            # Parse resolution into width and height
            WIDTH=$(echo $RES | cut -d'x' -f1)
            HEIGHT=$(echo $RES | cut -d'x' -f2)

            timeout 15 ./bin/edgefirst-camera --jpeg --camera-size "$WIDTH $HEIGHT" 2>&1
            EXIT_CODE=$?

            if [ $EXIT_CODE -eq 124 ]; then
              echo "âœ“ Resolution $RES passed (ran for 15 seconds)"
              TESTS_PASSED=$((TESTS_PASSED + 1))
            elif [ $EXIT_CODE -eq 0 ]; then
              echo "âœ“ Resolution $RES passed"
              TESTS_PASSED=$((TESTS_PASSED + 1))
            else
              echo "âœ— Resolution $RES failed with exit code $EXIT_CODE"
              TESTS_FAILED=$((TESTS_FAILED + 1))
            fi
          done

          echo ""
          echo "=== Multi-resolution test summary ==="
          echo "Passed: $TESTS_PASSED"
          echo "Failed: $TESTS_FAILED"

          # At least one resolution must work
          if [ $TESTS_PASSED -eq 0 ]; then
            echo "ERROR: No resolution tests passed!"
            exit 1
          fi
          echo "âœ“ Multi-resolution test completed"

      - name: Generate test summary
        if: always()
        run: |
          echo "# ðŸ§ª Hardware Test Results (imx8mp)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Environment" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: NXP i.MX 8M Plus EVK" >> $GITHUB_STEP_SUMMARY
          echo "- **Architecture**: aarch64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Tests Executed" >> $GITHUB_STEP_SUMMARY
          echo "- Binary help output" >> $GITHUB_STEP_SUMMARY
          echo "- JPEG capture (15 second streaming test)" >> $GITHUB_STEP_SUMMARY
          echo "- H.264 encoding (15 second streaming test)" >> $GITHUB_STEP_SUMMARY
          echo "- Multi-resolution streaming (640x480, 1280x720, 1920x1080)" >> $GITHUB_STEP_SUMMARY
